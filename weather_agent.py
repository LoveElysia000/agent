from langchain.agents import AgentExecutor, create_tool_calling_agent
from langchain_core.prompts import ChatPromptTemplate
from model_config import get_qwen_model
from weather_tools import get_weather_tools

class WeatherAgent:
    def __init__(self):
        """åˆå§‹åŒ–å¤©æ°”é¢„æŠ¥Agent"""
        # è·å–æ¨¡å‹
        self.llm = get_qwen_model()
        
        # è·å–å·¥å…·
        self.tools = get_weather_tools()
        
        # å®šä¹‰ç³»ç»Ÿæç¤ºè¯
        self.system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¤©æ°”é¢„æŠ¥åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„è¦æ±‚ï¼Œä½¿ç”¨å¯ç”¨çš„å·¥å…·è·å–å¤©æ°”ä¿¡æ¯å¹¶ç»™å‡ºè¯¦ç»†çš„å›ç­”ã€‚

è§„åˆ™ï¼š
1. å½“ç”¨æˆ·è¯¢é—®å½“å‰å¤©æ°”æ—¶ï¼Œä½¿ç”¨get_current_weatherå·¥å…·
2. **å½“ç”¨æˆ·è¯¢é—®ç‰¹å®šæ—¥æœŸçš„å¤©æ°”æ—¶ï¼ˆå¦‚"æ˜å¤©"ã€"åå¤©"ï¼‰ï¼Œä½¿ç”¨get_specific_day_weatherå·¥å…·**
   - è¯¥å·¥å…·ä¼šå‡†ç¡®è®¡ç®—ç›®æ ‡æ—¥æœŸå¹¶è¿”å›å¯¹åº”çš„å¤©æ°”é¢„æŠ¥
3. **å½“ç”¨æˆ·è¯¢é—®æœªæ¥å¤šå¤©å¤©æ°”é¢„æŠ¥æ—¶ï¼Œä½¿ç”¨get_weather_forecastå·¥å…·**
   - æ³¨æ„ï¼šè¯¥å·¥å…·è¿”å›ä»å½“å¤©å¼€å§‹çš„é¢„æŠ¥æ•°æ®
4. **å½“ç”¨æˆ·è¯¢é—®æ¶‰åŠæ³•å®šå‡æ—¥çš„å¤©æ°”æ—¶ï¼ˆå¦‚"å›½åº†èŠ‚å¤©æ°”"ã€"æ˜¥èŠ‚å‡æœŸå¤©æ°”"ç­‰ï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨get_holiday_weatherå·¥å…·**
   - è¯¥å·¥å…·ä¼šè‡ªåŠ¨æŸ¥è¯¢å‡æ—¥æœŸèŒƒå›´å¹¶è·å–å¯¹åº”çš„å¤©æ°”é¢„æŠ¥
   - å¦‚æœæ— æ³•ä½¿ç”¨get_holiday_weatherï¼Œåˆ™å¯ä»¥åˆ†åˆ«ä½¿ç”¨check_holiday_date_rangeå’Œget_weather_forecast
5. å¦‚æœå‡æ—¥æ—¥æœŸè¶…å‡ºäº†å¤©æ°”é¢„æŠ¥å¯ç”¨çš„èŒƒå›´ï¼Œè¦**å®äº‹æ±‚æ˜¯åœ°è¯´æ˜æ•°æ®é™åˆ¶ï¼Œç»å¯¹ä¸è¦çŒœæµ‹æˆ–è™šæ„å¤©æ°”ä¿¡æ¯**
6. å½“å¤©æ°”é¢„æŠ¥æ•°æ®ä¸ºç©ºæˆ–éƒ¨åˆ†è¦†ç›–æ—¶ï¼Œæ˜ç¡®è¯´æ˜ç¼ºå°‘æ•°æ®çš„å…·ä½“åŸå› 
7. æ”¯æŒæŸ¥è¯¢çš„æ³•å®šå‡æ—¥åŒ…æ‹¬ï¼šå…ƒæ—¦ã€æ˜¥èŠ‚ã€æ¸…æ˜èŠ‚ã€åŠ³åŠ¨èŠ‚ã€ç«¯åˆèŠ‚ã€ä¸­ç§‹èŠ‚ã€å›½åº†èŠ‚
8. å¯¹äºæ‰€æœ‰å‡æ—¥ç›¸å…³æŸ¥è¯¢ï¼Œä¸è¦çŒœæµ‹æ—¥æœŸï¼Œä¸€å®šè¦é€šè¿‡å·¥å…·æŸ¥è¯¢å‡†ç¡®ä¿¡æ¯
9. **ä¸è¦é”™è¯¯åˆ¤æ–­æ—¥æœŸå…³ç³»**ï¼šå½“å‰æ˜¯2025å¹´9æœˆ26æ—¥ï¼Œå› æ­¤ï¼š
   - 2025-09-26æ˜¯ä»Šå¤©
   - 2025-09-27æ˜¯æ˜å¤©
   - 2025-09-28æ˜¯åå¤©
10. åœ¨æ¯ä¸ªå¤©æ°”ä¿¡æ¯é¡¹å‰ä½¿ç”¨å¯¹åº”çš„å›¾æ ‡ï¼š
    - å¯¹äºæ¸©åº¦ä¿¡æ¯ï¼Œä½¿ç”¨ğŸŒ¡ï¸å›¾æ ‡
    - å¯¹äºä½“æ„Ÿæ¸©åº¦ä¿¡æ¯ï¼Œä½¿ç”¨ğŸ¤’å›¾æ ‡
    - å¯¹äºå¤©æ°”çŠ¶å†µï¼Œæ ¹æ®å…·ä½“å¤©æ°”ä½¿ç”¨å¯¹åº”å›¾æ ‡ï¼šâ˜€ï¸(æ™´), â˜ï¸(å¤šäº‘), ğŸŒ§ï¸(é›¨), â„ï¸(é›ª), â›ˆï¸(é›·é›¨), ğŸŒ¦ï¸(æ¯›æ¯›é›¨), ğŸŒ«ï¸(é›¾)
    - å¯¹äºæ—¶é—´æ®µï¼Œä½¿ç”¨ä»¥ä¸‹æ ‡ç­¾ï¼šæ¸…æ™¨(06-09ç‚¹), ä¸Šåˆ(09-12ç‚¹), ä¸­åˆ(12-15ç‚¹), ä¸‹åˆ(15-18ç‚¹), å‚æ™š(18-21ç‚¹), æ™šä¸Š(21-06ç‚¹)
    - å¯¹äºæ¹¿åº¦ä¿¡æ¯ï¼Œä½¿ç”¨ğŸ’§å›¾æ ‡
    - å¯¹äºé£é€Ÿä¿¡æ¯ï¼Œä½¿ç”¨ğŸ’¨å›¾æ ‡
    - å¯¹äºæ°”å‹ä¿¡æ¯ï¼Œä½¿ç”¨â²ï¸å›¾æ ‡
11. **å¤©æ°”é¢„æŠ¥å¿…é¡»æŒ‰æ—¶é—´æ®µåˆ†ç»„æ˜¾ç¤ºï¼Œä½¿ç”¨ç«–æ’åˆ—è¡¨æ ¼å¼**ï¼š
    - æ¯ä¸ªæ—¶é—´æ®µæ˜¾ç¤ºä¸ºä¸€ä¸ªç‹¬ç«‹çš„åŒºå—
    - æ¯ä¸ªåŒºå—åŒ…å«ï¼š
      - å¤©æ°”çŠ¶å†µğŸŒ¤ï¸
      - æ¸©åº¦ğŸŒ¡ï¸
      - æ¹¿åº¦ğŸ’§
      - é£é€ŸğŸ’¨
      - æ°”å‹â²ï¸
    - æ ¼å¼ç¤ºä¾‹ï¼š
    **ä¸Šåˆ (09:00)**  
    - ğŸŒ¤ï¸ å¤©æ°”ï¼šæ™´  
    - ğŸŒ¡ï¸ æ¸©åº¦ï¼š31.04Â°C  
    - ğŸ’§ æ¹¿åº¦ï¼š72%  
    - ğŸ’¨ é£é€Ÿï¼š2.14 m/s
    - â²ï¸ æ°”å‹ï¼š1012 hPa
    - ä¿æŒæ¸©åº¦çš„å°æ•°ä½ç²¾åº¦ï¼Œä¸è¦å››èˆäº”å…¥åˆ°æ•´æ•°
12. åœ¨åŸå¸‚æ¯”è¾ƒçš„æ€»ç»“éƒ¨åˆ†ä¹Ÿè¦ä½¿ç”¨å¯¹åº”çš„å›¾æ ‡
13. å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šåŸå¸‚ï¼Œè¯·è¯¢é—®å…·ä½“åŸå¸‚
14. åœ¨å¤©æ°”é¢„æŠ¥å›ç­”çš„æœ€åï¼Œ**å¿…é¡»æä¾›è¯¦ç»†çš„åˆ†ææ€»ç»“ï¼Œå¹¶åœ¨æ€»ç»“ä¸­ä½¿ç”¨å¯¹åº”çš„å›¾æ ‡**ï¼š
    - ğŸŒ¡ï¸ **åˆ†ææ•´ä½“å¤©æ°”è¶‹åŠ¿**ï¼ˆæ¸©åº¦å˜åŒ–ã€ä¸»è¦å¤©æ°”ç°è±¡ï¼‰
    - âš ï¸ **æŒ‡å‡ºéœ€è¦æ³¨æ„çš„ç‰¹æ®Šå¤©æ°”**ï¼ˆé™é›¨ğŸŒ§ï¸ã€é«˜æ¸©ğŸŒ¡ï¸ã€å¤§é£ğŸ’¨ç­‰ï¼‰
    - ğŸ’ **ç»™å‡ºå…·ä½“çš„å‡ºè¡Œå»ºè®®å’Œæ³¨æ„äº‹é¡¹**
    - ğŸ¤’ **åˆ†ææ¹¿åº¦å’Œé£é€Ÿå¯¹ä½“æ„Ÿçš„å½±å“**
    - ğŸ‘• **æä¾›é’ˆå¯¹æ€§çš„ç©¿è¡£å’Œæ´»åŠ¨å»ºè®®**
15. æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡å›ç­”

è¯·æ ¹æ®ç”¨æˆ·çš„å…·ä½“é—®é¢˜é€‰æ‹©åˆé€‚çš„å·¥å…·å’Œå›ç­”æ–¹å¼ã€‚"

è¯·æ ¹æ®ç”¨æˆ·çš„å…·ä½“é—®é¢˜é€‰æ‹©åˆé€‚çš„å·¥å…·å’Œå›ç­”æ–¹å¼ã€‚"""
        
        # åˆ›å»ºæç¤ºè¯æ¨¡æ¿
        self.prompt = ChatPromptTemplate.from_messages([
            ("system", self.system_prompt),
            ("placeholder", "{chat_history}"),
            ("human", "{input}"),
            ("placeholder", "{agent_scratchpad}"),
        ])
        
        # åˆ›å»ºAgent
        self.agent = create_tool_calling_agent(
            llm=self.llm,
            tools=self.tools,
            prompt=self.prompt
        )
        
        # åˆ›å»ºAgentæ‰§è¡Œå™¨
        self.agent_executor = AgentExecutor(
            agent=self.agent,
            tools=self.tools,
            verbose=True,
            handle_parsing_errors=True
        )
    
    def query(self, user_input: str) -> str:
        """å¤„ç†ç”¨æˆ·æŸ¥è¯¢"""
        try:
            result = self.agent_executor.invoke({
                "input": user_input,
                "agent_scratchpad": [],
                "chat_history": []
            })
            return result.get("output", "æ²¡æœ‰è·å¾—æœ‰æ•ˆå›ç­”")
        except Exception as e:
            return f"æŸ¥è¯¢è¿‡ç¨‹ä¸­å‡ºé”™: {str(e)}"
    
    def get_available_tools(self):
        """è¿”å›å¯ç”¨çš„å·¥å…·åˆ—è¡¨"""
        return [tool.name for tool in self.tools]

if __name__ == "__main__":
    # æµ‹è¯•Agent
    agent = WeatherAgent()
    print("å¯ç”¨å·¥å…·:", agent.get_available_tools())
    
    # æµ‹è¯•æŸ¥è¯¢
    test_query = "åŒ—äº¬ç°åœ¨çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
    print(f"æµ‹è¯•æŸ¥è¯¢: {test_query}")
    response = agent.query(test_query)
    print("å“åº”:", response)